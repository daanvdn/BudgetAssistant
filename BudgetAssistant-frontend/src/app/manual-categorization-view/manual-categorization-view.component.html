<mat-toolbar color="primary" class="toolbar-header">
  <span>Uncategorized Transactions</span>
  @if (totalToReview() > 0) {
    <span class="review-badge">{{ totalToReview() }} remaining</span>
  }
</mat-toolbar>

<div class="categorization-container">
  <div class="content-wrapper">
    <!-- Action Bar -->
    <div class="action-bar">
      <div class="action-bar-left">
        <bank-account-selection class="bank-account-selector"></bank-account-selection>

          <mat-button-toggle-group
                  [value]="activeView() === 'EXPENSES' ? 'expenses' : 'revenue'"
                  (change)="onToggleChange($event)"
                  class="view-toggle">
              <mat-button-toggle value="expenses">Expenses</mat-button-toggle>
              <mat-button-toggle value="revenue">Revenue</mat-button-toggle>
          </mat-button-toggle-group>
      </div>

      <div class="action-bar-right">
        <mat-paginator
          [length]="pagination().totalElements"
          [pageSize]="pagination().size"
          [pageIndex]="pagination().page"
          [pageSizeOptions]="[25, 50, 100]"
          (page)="onPageChange($event)"
          showFirstLastButtons>
        </mat-paginator>
      </div>
    </div>

    <!-- Table Content -->
    <div class="table-container">
      @if (isLoading()) {
        <div class="loading-container">
          <mat-spinner diameter="48"></mat-spinner>
          <p>Loading transactions...</p>
        </div>
      } @else if (isEmpty()) {
        <div class="empty-state">
          <mat-icon class="empty-icon">check_circle_outline</mat-icon>
          <h3>No uncategorized transactions</h3>
          <p>All transactions for this account have been categorized.</p>
        </div>
      } @else {
        @if (!breakpointService.isMobile()) {
        <!-- Desktop Table View -->
        <div class="desktop-table">
          <table mat-table [dataSource]="tableRows()" class="categorization-table">
            <!-- Transaction Column -->
            <ng-container matColumnDef="transaction">
              <th mat-header-cell *matHeaderCellDef>Transaction</th>
              <td mat-cell *matCellDef="let item">
                <div class="transaction-cell">
                  <span class="transaction-text">{{ item.transaction }}</span>
                  @if (item.transaction !== item.communications && item.communications) {
                    <span class="communications-text">{{ item.communications }}</span>
                  }
                </div>
              </td>
            </ng-container>

            <!-- Amount Column -->
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef>Amount</th>
              <td mat-cell *matCellDef="let item">
                <span class="amount-cell"
                      [class.positive]="item.amount >= 0"
                      [class.negative]="item.amount < 0">
                  {{ item.amount | number:'1.2-2' }} {{ item.currency }}
                </span>
              </td>
            </ng-container>

            <!-- Category Column -->
            <ng-container matColumnDef="category">
              <th mat-header-cell *matHeaderCellDef>Category</th>
              <td mat-cell *matCellDef="let item">
                <app-category-tree-dropdown
                  (selectionChange)="setCategory(item, $event)"
                  [selectedCategoryQualifiedNameStr]="getCategoryQualifiedName(item)"
                  [transactionTypeEnum]="amountType(item)">
                </app-category-tree-dropdown>
              </td>
            </ng-container>

            <!-- Group Header Column -->
            <ng-container matColumnDef="groupHeader">
              <td mat-cell *matCellDef="let group" class="group-header-cell">
                <div class="group-header-content">
                  <mat-icon class="group-icon">people</mat-icon>
                  <strong>{{ group.counterpartyName || 'Unknown' }}</strong>
                  <span class="group-count">({{ group.transactions.length }})</span>
                </div>
              </td>
            </ng-container>

            <!-- Group Category Column (for bulk assignment) -->
            <ng-container matColumnDef="groupCategory">
              <td mat-cell *matCellDef="let group" class="group-category-cell">
                <app-category-tree-dropdown
                  (selectionChange)="setCategory(group, $event)"
                  [transactionTypeEnum]="amountType(group)">
                </app-category-tree-dropdown>
              </td>
            </ng-container>

            <!-- Group Amount Placeholder -->
            <ng-container matColumnDef="groupAmount">
              <td mat-cell *matCellDef="let group"></td>
            </ng-container>

            <!-- Regular rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns; when: isTransaction"
                class="transaction-row"></tr>

            <!-- Group header rows -->
            <tr mat-row *matRowDef="let row; columns: ['groupHeader', 'groupAmount', 'groupCategory']; when: isGroup"
                class="group-row"></tr>
          </table>
        </div>
        } @else {
        <!-- Mobile Card View -->
        <div class="mobile-cards">
          @for (group of groupedTransactions(); track group.name) {
            <div class="group-card">
              <div class="group-card-header">
                <div class="group-card-title">
                  <mat-icon>people</mat-icon>
                  <span>{{ group.name || 'Unknown' }}</span>
                  <span class="group-count">({{ group.transactions.length }})</span>
                </div>
                <app-category-tree-dropdown
                  class="group-category-dropdown"
                  (selectionChange)="setCategory({kind: 'group', counterpartyName: group.name, transactions: group.transactions, isExpense: group.isExpense}, $event)"
                  [transactionTypeEnum]="group.isExpense ? 'EXPENSES' : 'REVENUE'">
                </app-category-tree-dropdown>
              </div>

              @for (tx of group.transactions; track tx.transactionId) {
                <mat-card class="transaction-card">
                  <mat-card-content>
                    <div class="card-row">
                      <div class="card-transaction-info">
                        @if (tx.transaction) {
                          <span class="transaction-text">{{ tx.transaction }}</span>
                        }
                        @if (tx.transaction !== tx.communications && tx.communications) {
                          <span class="communications-text">{{ tx.communications }}</span>
                        }
                      </div>
                      <span class="card-amount"
                            [class.positive]="tx.amount >= 0"
                            [class.negative]="tx.amount < 0">
                        {{ tx.amount | number:'1.2-2' }} {{ tx.currency }}
                      </span>
                    </div>
                    <div class="card-category">
                      <app-category-tree-dropdown
                        (selectionChange)="setCategory(tx, $event)"
                        [selectedCategoryQualifiedNameStr]="getCategoryQualifiedName(tx)"
                        [transactionTypeEnum]="amountType(tx)">
                      </app-category-tree-dropdown>
                    </div>
                  </mat-card-content>
                </mat-card>
              }
            </div>
          }
        </div>
        }

        <!-- Bottom Paginator -->
        <div class="bottom-paginator">
          <mat-paginator
            [length]="pagination().totalElements"
            [pageSize]="pagination().size"
            [pageIndex]="pagination().page"
            [pageSizeOptions]="[25, 50, 100]"
            (page)="onPageChange($event)"
            showFirstLastButtons>
          </mat-paginator>
        </div>
      }
    </div>
  </div>
</div>
