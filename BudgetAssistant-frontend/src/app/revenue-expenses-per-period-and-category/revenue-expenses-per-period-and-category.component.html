<!-- Context Menu Template -->
<ng-template #contextMenuTemplate cdkMenuPanel>
  <div class="context-menu" cdkMenu>
    <button class="context-menu-item" cdkMenuItem (click)="onShowTransactions()">
      <mat-icon>visibility</mat-icon>
      <span>Show Transactions</span>
    </button>
  </div>
</ng-template>

<div class="component-container">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Loading category breakdown...</p>
    </div>
  }

  <!-- Error State -->
  @if (hasError()) {
    <div class="error-container">
      <mat-icon class="error-icon">error_outline</mat-icon>
      <h3>Failed to load data</h3>
      <p>There was an error fetching the category breakdown. Please try again.</p>
    </div>
  }

  <!-- Empty State -->
  @if (isEmpty() && !hasError()) {
    <div class="empty-state">
      <mat-icon class="empty-icon">category</mat-icon>
      <h3>No data available</h3>
      <p>Select a bank account and date range to see the category breakdown.</p>
    </div>
  }

  <!-- Data Content -->
  @if (hasData() && criteria()) {
    <div class="content-wrapper">
      <!-- Chart Section -->
      <section class="chart-section">
        <div class="section-header">
          <h2>Category Distribution</h2>
          <span class="transaction-type-badge" [class.expenses]="criteria()?.transactionType === TransactionTypeEnum.EXPENSES"
                [class.revenue]="criteria()?.transactionType === TransactionTypeEnum.REVENUE">
            {{ criteria()?.transactionType === TransactionTypeEnum.EXPENSES ? 'Expenses' : 
               criteria()?.transactionType === TransactionTypeEnum.REVENUE ? 'Revenue' : 'All' }}
          </span>
        </div>
        <div class="chart-container">
          @if (chartData()) {
            <p-chart 
              type="bar" 
              [data]="chartData()" 
              [options]="chartOptions" 
              [plugins]="chartPlugins"
              (onDataSelect)="handleDataSelect($event)">
            </p-chart>
          }
        </div>
      </section>

      <!-- Table Section -->
      <section class="table-section">
        <div class="section-header">
          <h2 [matTooltip]="tableInfoTooltip" matTooltipPosition="above">
            Breakdown by Period
            <mat-icon class="info-icon">info_outline</mat-icon>
          </h2>
        </div>

        <!-- Desktop Table -->
        <div class="desktop-table">
          <div class="table-wrapper">
            <table mat-table [dataSource]="tableData()" class="category-table">
              <!-- Category Column (Sticky) -->
              <ng-container matColumnDef="category" [sticky]="true">
                <th mat-header-cell *matHeaderCellDef class="category-header">Category</th>
                <td mat-cell *matCellDef="let element" class="category-cell">
                  {{ element.category }}
                </td>
              </ng-container>

              <!-- Period Columns -->
              @for (column of periodColumns(); track column) {
                <ng-container [matColumnDef]="column">
                  <th mat-header-cell *matHeaderCellDef class="period-header">{{ column }}</th>
                  <td mat-cell *matCellDef="let element"
                      class="amount-cell"
                      [class.anomaly]="isAnomaly(element, column)"
                      [class.negative]="getCellValue(element, column) < 0"
                      [class.positive]="getCellValue(element, column) > 0"
                      (contextmenu)="openContextMenu(column, element.category, element.categoryId, $event)"
                      [cdkContextMenuTriggerFor]="contextMenuTemplate">
                    {{ formatAmount(getCellValue(element, column)) }}
                  </td>
                </ng-container>
              }

              <tr mat-header-row *matHeaderRowDef="displayedColumns(); sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns();" class="data-row"></tr>
            </table>
          </div>
        </div>

        <!-- Mobile Cards -->
        <div class="mobile-cards">
          @for (row of tableData(); track row.category) {
            <mat-card class="category-card">
              <mat-card-header>
                <mat-card-title>{{ row.category }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="period-list">
                  @for (column of periodColumns(); track column) {
                    <div class="period-item"
                         [class.anomaly]="isAnomaly(row, column)"
                         (contextmenu)="openContextMenu(column, row.category, row.categoryId, $event)"
                         [cdkContextMenuTriggerFor]="contextMenuTemplate">
                      <span class="period-label">{{ column }}</span>
                      <span class="period-amount"
                            [class.negative]="getCellValue(row, column) < 0"
                            [class.positive]="getCellValue(row, column) > 0">
                        {{ formatAmount(getCellValue(row, column)) }}
                      </span>
                    </div>
                  }
                </div>
              </mat-card-content>
            </mat-card>
          }
        </div>
      </section>
    </div>
  }
</div>
