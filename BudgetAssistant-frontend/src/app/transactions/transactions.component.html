<mat-toolbar color="primary" class="toolbar-header">
    <span>Transactions</span>
</mat-toolbar>

<div class="transactions-container">
    <!-- Loading Overlay -->
    @if (filesAreUploading()) {
        <div class="overlay">
            <div class="spinner-container">
                <h3>Uploading files...</h3>
                <mat-spinner diameter="48"></mat-spinner>
            </div>
        </div>
    }

    <div class="content-wrapper">
        <!-- Action Bar -->
        <div class="action-bar">
            <div class="action-bar-left">
                <bank-account-selection
                        class="bank-account-selector"
                        (change)="handleAccountChange()">
                </bank-account-selection>

                <div class="action-buttons">
                    <button
                            mat-icon-button
                            class="action-button"
                            (click)="onClickFileInputButton()"
                            matTooltip="Upload transactions (CSV)">
                        <input
                                type="file"
                                hidden
                                #fileInput
                                accept=".csv"
                                multiple
                                (change)="onChangeFileInput()"/>
                        <mat-icon>add_to_photos</mat-icon>
                    </button>

                    <button
                            mat-icon-button
                            class="action-button"
                            (click)="openSearchDialog()"
                            matTooltip="Search transactions">
                        <mat-icon>search</mat-icon>
                    </button>

                    <button
                            mat-icon-button
                            class="action-button"
                            (click)="showAllTransactions()"
                            matTooltip="Show all transactions">
                        <mat-icon>visibility</mat-icon>
                    </button>

                    <button
                            mat-icon-button
                            class="action-button"
                            [matBadge]="getNrOfTransactionsToManuallyReview()"
                            matBadgeColor="warn"
                            matBadgeOverlap="true"
                            [matTooltip]="getNrOfTransactionsToManuallyReviewTooltip()"
                            (click)="showTransactionsToManuallyReview()">
                        <fa-icon [icon]="faTag"></fa-icon>
                    </button>
                </div>
            </div>

            <div class="action-bar-right">
                @if (hasViewTypeLabel()) {
                    <span class="view-type-label">{{ viewTypeLabel() }}</span>
                }

                <mat-paginator
                        [length]="pagination().totalElements"
                        [pageSize]="pagination().size"
                        [pageIndex]="pagination().page"
                        [pageSizeOptions]="[10, 20, 50, 100]"
                        (page)="onPageChange($event)"
                        showFirstLastButtons>
                </mat-paginator>
            </div>
        </div>

        <!-- Table Content -->
        <div class="table-container">
            @if (isLoading()) {
                <div class="loading-container">
                    <mat-spinner diameter="48"></mat-spinner>
                    <p>Loading transactions...</p>
                </div>
            } @else if (isEmpty()) {
                <div class="empty-state">
                    <mat-icon class="empty-icon">receipt_long</mat-icon>
                    @if (isEmptyDueToSearch()) {
                        <h3>Found no transactions that match your search criteria</h3>
                    } @else {
                        <h3>No transactions found</h3>
                        <p>Upload CSV files or select a different bank account to see transactions.</p>
                    }
                </div>
            } @else {
                <!-- Desktop Table View -->
                <div class="desktop-table">
                    <table
                            mat-table
                            [dataSource]="transactions()"
                            matSort
                            (matSortChange)="onSortChange($event)"
                            matSortDisableClear
                            matSortActive="bookingDate"
                            matSortDirection="desc">

                        <!-- Date Column -->
                        <ng-container matColumnDef="bookingDate">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                            <td mat-cell *matCellDef="let item">
                                <span class="date-cell">{{ formatDate(item.bookingDate) }}</span>
                            </td>
                        </ng-container>

                        <!-- Counterparty Column -->
                        <ng-container matColumnDef="counterparty">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Counterparty</th>
                            <td mat-cell *matCellDef="let item">
                                <div class="counterparty-cell">
                                    <span class="counterparty-name">{{ item.counterparty?.name | titlecase }}</span>
                                    @if (item.counterparty?.accountNumber) {
                                        <span class="counterparty-account">{{ item.counterparty.accountNumber }}</span>
                                    }
                                    @if (item.counterparty?.streetAndNumber || item.counterparty?.zipCodeAndCity) {
                                        <span class="counterparty-address">
                      {{ item.counterparty.streetAndNumber }} {{ item.counterparty.zipCodeAndCity }}
                    </span>
                                    }
                                </div>
                            </td>
                        </ng-container>

                        <!-- Transaction Column -->
                        <ng-container matColumnDef="transaction">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Transaction</th>
                            <td mat-cell *matCellDef="let item">
                                <div class="transaction-cell">
                                    <span class="transaction-text">{{ item.transaction }}</span>
                                    @if (item.transaction !== item.communications && item.communications) {
                                        <span class="communications-text">{{ item.communications }}</span>
                                    }
                                </div>
                            </td>
                        </ng-container>

                        <!-- Amount Column -->
                        <ng-container matColumnDef="amount">
                            <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
                            <td mat-cell *matCellDef="let item">
                <span class="amount-cell" [class.positive]="item.amount >= 0" [class.negative]="item.amount < 0">
                  {{ item.amount | number:'1.2-2' }} {{ item.currency }}
                </span>
                            </td>
                        </ng-container>

                        <!-- Transaction Type / Properties Column -->
                        <ng-container matColumnDef="transactionType">
                            <th mat-header-cell *matHeaderCellDef>Properties</th>
                            <td mat-cell *matCellDef="let item">
                                <div class="properties-cell">
                                    <div class="property-row">
                                        <span class="property-label">Category</span>
                                        <app-category-tree-dropdown
                                                (selectionChange)="setCategory(item, $event)"
                                                [selectedCategoryQualifiedNameStr]="getCategoryQualifiedName(item)"
                                                [transactionTypeEnum]="amountType(item)">
                                        </app-category-tree-dropdown>
                                    </div>

                                    <div class="property-row">
                                        <span class="property-label">Recurring</span>
                                        <mat-radio-group (change)="setIsRecurring(item, $event)">
                                            <mat-radio-button [value]="true" [checked]="item.isRecurring === true">Yes
                                            </mat-radio-button>
                                            <mat-radio-button [value]="false" [checked]="item.isRecurring === false">
                                                No
                                            </mat-radio-button>
                                        </mat-radio-group>
                                    </div>

                                    <div class="property-row">
                                        <span class="property-label">Needs reimbursement</span>
                                        <mat-radio-group (change)="setIsAdvanceSharedAccount(item, $event)">
                                            <mat-radio-button [value]="true"
                                                              [checked]="item.isAdvanceSharedAccount === true">Yes
                                            </mat-radio-button>
                                            <mat-radio-button [value]="false"
                                                              [checked]="item.isAdvanceSharedAccount === false">No
                                            </mat-radio-button>
                                        </mat-radio-group>
                                    </div>
                                </div>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns" class="transaction-row"></tr>
                    </table>
                </div>

                <!-- Mobile Card View -->
                <div class="mobile-cards">
                    @for (item of transactions(); track item.transactionId) {
                        <mat-card class="transaction-card">
                            <mat-card-content>
                                <div class="card-header">
                                    <span class="card-date">{{ formatDate(item.bookingDate) }}</span>
                                    <span class="card-amount" [class.positive]="item.amount >= 0"
                                          [class.negative]="item.amount < 0">
                    {{ item.amount | number:'1.2-2' }} {{ item.currency }}
                  </span>
                                </div>

                                <div class="card-counterparty">
                                    <span class="counterparty-name">{{ item.counterparty?.name | titlecase }}</span>
                                    @if (item.counterparty?.accountNumber) {
                                        <span class="counterparty-account">{{ item.counterparty.accountNumber }}</span>
                                    }
                                </div>

                                @if (item.transaction) {
                                    <div class="card-transaction">
                                        <span class="transaction-text">{{ item.transaction }}</span>
                                    </div>
                                }

                                <div class="card-properties">
                                    <div class="property-row">
                                        <span class="property-label">Category</span>
                                        <app-category-tree-dropdown
                                                (selectionChange)="setCategory(item, $event)"
                                                [selectedCategoryQualifiedNameStr]="getCategoryQualifiedName(item)"
                                                [transactionTypeEnum]="amountType(item)">
                                        </app-category-tree-dropdown>
                                    </div>

                                    <div class="property-row inline">
                                        <div class="inline-property">
                                            <span class="property-label">Recurring</span>
                                            <mat-radio-group (change)="setIsRecurring(item, $event)">
                                                <mat-radio-button [value]="true" [checked]="item.isRecurring === true">
                                                    Yes
                                                </mat-radio-button>
                                                <mat-radio-button [value]="false"
                                                                  [checked]="item.isRecurring === false">No
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                        <div class="inline-property">
                                            <span class="property-label">Reimburse</span>
                                            <mat-radio-group (change)="setIsAdvanceSharedAccount(item, $event)">
                                                <mat-radio-button [value]="true"
                                                                  [checked]="item.isAdvanceSharedAccount === true">Yes
                                                </mat-radio-button>
                                                <mat-radio-button [value]="false"
                                                                  [checked]="item.isAdvanceSharedAccount === false">No
                                                </mat-radio-button>
                                            </mat-radio-group>
                                        </div>
                                    </div>
                                </div>
                            </mat-card-content>
                        </mat-card>
                    }
                </div>

                <!-- Bottom Paginator -->
                <div class="bottom-paginator">
                    <mat-paginator
                            [length]="pagination().totalElements"
                            [pageSize]="pagination().size"
                            [pageIndex]="pagination().page"
                            [pageSizeOptions]="[10, 20, 50, 100]"
                            (page)="onPageChange($event)"
                            showFirstLastButtons>
                    </mat-paginator>
                </div>
            }
        </div>
    </div>
</div>
