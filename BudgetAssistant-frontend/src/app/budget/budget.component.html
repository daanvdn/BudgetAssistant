<mat-toolbar color="primary" class="toolbar-header">
  <span>Budget</span>
</mat-toolbar>

<div class="budget-container">
  <!-- Action Bar -->
  <div class="action-bar">
    <div class="action-bar-left">
      <bank-account-selection class="bank-account-selector"></bank-account-selection>
    </div>

    <div class="action-bar-right">
      <button mat-icon-button
              (click)="saveAll()"
              matTooltip="Alles opslaan"
              [disabled]="isSaving() || !dataLoaded()">
        <mat-icon>save</mat-icon>
      </button>

      <button mat-icon-button
              (click)="toggleTree()"
              [matTooltip]="isTreeExpanded() ? 'Inklappen' : 'Uitklappen'"
              [disabled]="!dataLoaded()">
        <mat-icon>{{ isTreeExpanded() ? 'unfold_less' : 'unfold_more' }}</mat-icon>
      </button>
    </div>
  </div>

  <!-- Loading state -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="48"></mat-spinner>
      <p>Budget laden…</p>
    </div>
  }

  <!-- Empty state -->
  @if (!isLoading() && !dataLoaded() && selectedAccount()) {
    <div class="empty-state">
      <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
      <h3>Geen budget gevonden</h3>
      <p>Selecteer een bankrekening om het budget te bekijken of aan te maken.</p>
    </div>
  }

  @if (dataLoaded()) {
    <!-- Budget tree table -->
    <form [formGroup]="mainForm" class="budget-table-wrapper">
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="budget-table">

          <!-- Category column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef>
              <span class="category-header">Categorie</span>
            </th>
            <td mat-cell *matCellDef="let data">
              <div class="category-cell" [style.padding-left.px]="data.level * 24">
                <button mat-icon-button
                        class="expand-btn"
                        [class.hidden]="!data.expandable"
                        (click)="treeControl.toggle(data)">
                  <mat-icon class="expand-icon">
                    {{ treeControl.isExpanded(data) ? 'keyboard_arrow_down' : 'keyboard_arrow_right' }}
                  </mat-icon>
                </button>
                <span class="category-name"
                      [class.total-label]="data.id === TOTAL_NODE_ID">{{ data.name }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Monthly budget column -->
          <ng-container matColumnDef="budget">
            <th mat-header-cell *matHeaderCellDef>Maandbudget</th>
            <td mat-cell *matCellDef="let data">
              @if (data.id !== TOTAL_NODE_ID) {
                <mat-form-field class="budget-input" appearance="outline">
                  <input matInput type="number"
                         [formControlName]="'' + data.id"
                         [errorStateMatcher]="matcher"
                         (focus)="determineSubTree(data)">
                  <span matSuffix class="currency-suffix">€</span>
                  @if (mainForm.get('' + data.id)!.hasError('negativeNumber')) {
                    <mat-error>Bedrag mag niet negatief zijn</mat-error>
                  }
                  @if (mainForm.get('' + data.id)!.hasError('isLessThanItsDescendants')) {
                    <mat-error>Som subcategorieën overschrijdt het budget</mat-error>
                  }
                </mat-form-field>
              } @else {
                <span class="total-amount">{{ totalBudget() | currency:'EUR':'symbol':'1.2-2' }}</span>
              }
            </td>
          </ng-container>

          <!-- Yearly budget column -->
          <ng-container matColumnDef="yearlyBudget">
            <th mat-header-cell *matHeaderCellDef>Jaarbudget</th>
            <td mat-cell *matCellDef="let data">
              @if (data.id !== TOTAL_NODE_ID) {
                <span class="yearly-amount">{{ (mainForm.controls[data.id] ? mainForm.controls[data.id].value : data.amount) * 12 | currency:'EUR':'symbol':'1.2-2' }}</span>
              } @else {
                <span class="total-amount">{{ totalBudget() * 12 | currency:'EUR':'symbol':'1.2-2' }}</span>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"
              [ngClass]="getRowClass(row)"></tr>
        </table>
      </div>
    </form>
  }

  <!-- Saving overlay -->
  @if (isSaving()) {
    <div class="saving-overlay">
      <mat-spinner diameter="36"></mat-spinner>
      <span>Opslaan…</span>
    </div>
  }
</div>
