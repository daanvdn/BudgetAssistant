<div class="dialog-container">
    <!-- Dialog Title -->
    <div mat-dialog-title class="dialog-title">
        <h2>Transactions</h2>
        <p class="dialog-subtitle">
            <span class="category-label">{{ categoryName() }}</span>
            <span class="period-separator">&bull;</span>
            <span class="period-label">{{ query.period }}</span>
        </p>
    </div>

    <!-- Dialog Content -->
    <div mat-dialog-content class="dialog-content">
        @if (isLoading()) {
            <div class="loading-container">
                <mat-spinner diameter="48"></mat-spinner>
                <p>Loading transactions...</p>
            </div>
        } @else if (isEmpty()) {
            <div class="empty-state">
                <mat-icon class="empty-icon">receipt_long</mat-icon>
                <h3>No transactions found</h3>
                <p>No transactions match this category and period.</p>
            </div>
        } @else {
            <!-- Top Paginator -->
            <div class="top-paginator">
                <mat-paginator
                    [length]="pagination().totalElements"
                    [pageSize]="pagination().size"
                    [pageIndex]="pagination().page"
                    [pageSizeOptions]="[20, 50, 100]"
                    (page)="onPageChange($event)"
                    showFirstLastButtons>
                </mat-paginator>
            </div>

            @if (!breakpointService.isMobile()) {
            <!-- Desktop Table View -->
            <div class="desktop-table">
                <table
                    mat-table
                    [dataSource]="transactions()"
                    matSort
                    (matSortChange)="onSortChange($event)"
                    matSortDisableClear
                    matSortActive="bookingDate"
                    matSortDirection="desc">

                    <!-- Date Column -->
                    <ng-container matColumnDef="bookingDate">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
                        <td mat-cell *matCellDef="let item">
                            <span class="date-cell">{{ formatDate(item.bookingDate) }}</span>
                        </td>
                    </ng-container>

                    <!-- Counterparty Column -->
                    <ng-container matColumnDef="counterparty">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Counterparty</th>
                        <td mat-cell *matCellDef="let item">
                            <div class="counterparty-cell">
                                <span class="counterparty-name">{{ item.counterparty.name | titlecase }}</span>
                                @if (item.counterparty.accountNumber) {
                                    <span class="counterparty-account">{{ item.counterparty.accountNumber }}</span>
                                }
                                @if (item.counterparty.streetAndNumber || item.counterparty.zipCodeAndCity) {
                                    <span class="counterparty-address">
                                        {{ item.counterparty.streetAndNumber }} {{ item.counterparty.zipCodeAndCity }}
                                    </span>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <!-- Transaction Column -->
                    <ng-container matColumnDef="transaction">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Transaction</th>
                        <td mat-cell *matCellDef="let item">
                            <div class="transaction-cell">
                                <span class="transaction-text">{{ item.transaction }}</span>
                                @if (item.transaction !== item.communications && item.communications) {
                                    <span class="communications-text">{{ item.communications }}</span>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <!-- Amount Column -->
                    <ng-container matColumnDef="amount">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
                        <td mat-cell *matCellDef="let item">
                            <span class="amount-cell" [class.positive]="item.amount >= 0" [class.negative]="item.amount < 0">
                                {{ item.amount | number:'1.2-2' }} {{ item.currency }}
                            </span>
                        </td>
                    </ng-container>

                    <!-- Category Column -->
                    <ng-container matColumnDef="transactionType">
                        <th mat-header-cell *matHeaderCellDef>Category</th>
                        <td mat-cell *matCellDef="let item">
                            <div class="category-cell">
                                <app-category-tree-dropdown
                                    (selectionChange)="setCategory(item, $event)"
                                    [selectedCategoryQualifiedNameStr]="getCategoryQualifiedName(item)"
                                    [transactionTypeEnum]="amountType(item)">
                                </app-category-tree-dropdown>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns" class="transaction-row"></tr>
                </table>
            </div>
            } @else {
            <!-- Mobile Card View -->
            <div class="mobile-cards">
                @for (item of transactions(); track item.transactionId) {
                    <mat-card class="transaction-card">
                        <mat-card-content>
                            <div class="card-header">
                                <span class="card-date">{{ formatDate(item.bookingDate) }}</span>
                                <span class="card-amount" [class.positive]="item.amount >= 0" [class.negative]="item.amount < 0">
                                    {{ item.amount | number:'1.2-2' }} {{ item.currency }}
                                </span>
                            </div>

                            <div class="card-counterparty">
                                <span class="counterparty-name">{{ item.counterparty.name | titlecase }}</span>
                                @if (item.counterparty.accountNumber) {
                                    <span class="counterparty-account">{{ item.counterparty.accountNumber }}</span>
                                }
                            </div>

                            @if (item.transaction) {
                                <div class="card-transaction">
                                    <span class="transaction-text">{{ item.transaction }}</span>
                                </div>
                            }

                            <div class="card-properties">
                                <app-category-tree-dropdown
                                    (selectionChange)="setCategory(item, $event)"
                                    [selectedCategoryQualifiedNameStr]="getCategoryQualifiedName(item)"
                                    [transactionTypeEnum]="amountType(item)">
                                </app-category-tree-dropdown>
                            </div>
                        </mat-card-content>
                    </mat-card>
                }
            </div>
            }

            <!-- Bottom Paginator -->
            <div class="bottom-paginator">
                <mat-paginator
                    [length]="pagination().totalElements"
                    [pageSize]="pagination().size"
                    [pageIndex]="pagination().page"
                    [pageSizeOptions]="[20, 50, 100]"
                    (page)="onPageChange($event)"
                    showFirstLastButtons>
                </mat-paginator>
            </div>
        }
    </div>

    <!-- Dialog Actions -->
    <div mat-dialog-actions class="dialog-actions">
        <button mat-raised-button color="primary" (click)="onCloseClick()">Close</button>
    </div>
</div>
