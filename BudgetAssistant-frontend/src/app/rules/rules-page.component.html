<mat-toolbar color="primary" class="toolbar-header">
    <span class="toolbar-spacer"></span>
    <span class="toolbar-title">Rules</span>
    <span class="toolbar-spacer"></span>
    <button mat-raised-button
            class="run-button"
            (click)="openRunCategorizationDialog()"
            matTooltip="Run categorization rules on all transactions">
        <mat-icon>play_arrow</mat-icon>
        Run Rules
    </button>
</mat-toolbar>

<div class="rules-container">
    <div class="content-wrapper">
        <!-- Action Bar -->
        <div class="action-bar">
            <mat-button-toggle-group id="expenses-revenue-toggle"
                    [value]="activeView()"
                    (change)="onToggleChange($event)"
                    aria-label="Transaction type">
                <mat-button-toggle value="expenses">Expenses</mat-button-toggle>
                <mat-button-toggle value="revenue">Revenue</mat-button-toggle>
            </mat-button-toggle-group>
        </div>

        <!-- Scrollable Content -->
        <div class="content-area">
            <mat-accordion multi class="category-accordion">
                @for (category of currentFlatCategories; track category.qualifiedName) {
                    <mat-expansion-panel (opened)="loadRuleSetWrapper(category)"
                                         (click)="loadRuleSetWrapper(category)">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                <span class="qualified-name">
                                    @for (segment of formatQualifiedName(category.qualifiedName); track $index; let last = $last) {
                                        <span class="category-segment">{{ segment }}</span>
                                        @if (!last) {
                                            <mat-icon class="separator-icon">chevron_right</mat-icon>
                                        }
                                    }
                                </span>
                                @if (isCategoryEmpty(category)) {
                                    <mat-chip class="empty-chip" disabled>empty</mat-chip>
                                }
                            </mat-panel-title>
                            <mat-panel-description>
                                @if (isLoadingRules(category)) {
                                    <mat-spinner diameter="20"></mat-spinner>
                                }
                            </mat-panel-description>
                        </mat-expansion-panel-header>

                        <app-rule-summary-card
                                [category]="category"
                                [ruleSetWrapper]="getRuleSetWrapper(category)"
                                [hasError]="hasRuleError(category)"
                                (edit)="onEditRules(category)"
                                (create)="onCreateRules(category)"
                                (retry)="onRetryLoad(category)">
                        </app-rule-summary-card>
                    </mat-expansion-panel>
                }
            </mat-accordion>

            @if (currentFlatCategories.length === 0) {
                <div class="empty-state">
                    <mat-icon class="empty-icon">category</mat-icon>
                    <p>No categories loaded yet.</p>
                </div>
            }
        </div>
    </div>
</div>
