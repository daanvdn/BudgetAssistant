<div class="summary-card" [class.empty]="!hasRules" [class.error]="hasError" role="region"
     [attr.aria-label]="'Rules for ' + category.name">
    <div class="card-header">
        <span class="status-badge" [class.active]="hasRules" [class.empty-badge]="!hasRules && !hasError" [class.error-badge]="hasError">
            @if (hasError) {
                <span class="status-dot error-dot"></span> ERROR
            } @else if (hasRules) {
                <span class="status-dot active-dot"></span> ACTIVE
            } @else {
                <span class="status-dot empty-dot"></span> EMPTY
            }
        </span>

        <div class="card-actions">
            @if (hasError) {
                <button mat-stroked-button
                        class="retry-button"
                        (click)="onRetry()"
                        aria-label="Retry loading rules"
                        matTooltip="Retry loading rules">
                    <mat-icon>refresh</mat-icon> Retry
                </button>
            } @else if (hasRules) {
                <button mat-icon-button
                        class="edit-button"
                        (click)="onEdit()"
                        aria-label="Edit rules"
                        matTooltip="Edit rules">
                    <mat-icon>edit</mat-icon>
                </button>
            } @else {
                <button mat-stroked-button
                        class="create-button"
                        (click)="onCreate()"
                        aria-label="Create rules for this category"
                        matTooltip="Create rules for this category">
                    <mat-icon>add</mat-icon> Create
                </button>
            }
        </div>
    </div>

    <div class="card-body">
        @if (hasError) {
            <p class="error-text">Failed to load rules. Check your backend connection.</p>
        } @else if (hasRules && summaryRoot) {
            <div class="rule-description">
                <span class="assign-label">Assign "{{ category.name }}" when</span>
                <ng-container *ngTemplateOutlet="summaryNodeTpl; context: { $implicit: summaryRoot }">
                </ng-container>
            </div>
        } @else {
            <p class="no-rules-text">No rules defined</p>
        }
    </div>
</div>

<!-- Recursive template for rendering SummaryNode tree -->
<ng-template #summaryNodeTpl let-node>
    @if (node.isGroup && node.children?.length) {
        <span class="condition-label">{{ node.condition }} of:</span>
        <ul class="rule-list">
            @for (child of node.children; track child.text) {
                <li>
                    @if (child.isGroup) {
                        <ng-container *ngTemplateOutlet="summaryNodeTpl; context: { $implicit: child }">
                        </ng-container>
                    } @else {
                        <span class="rule-text">{{ child.text }}</span>
                    }
                </li>
            }
        </ul>
    } @else if (!node.isGroup) {
        <span class="rule-text">{{ node.text }}</span>
    }
</ng-template>
